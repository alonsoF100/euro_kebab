-- =============================================
-- Создание базы данных для организаций
-- Реляционная структура с нормализованными таблицами
-- =============================================

-- Основная таблица организаций
CREATE TABLE organizations (
    id SERIAL PRIMARY KEY,
    inn VARCHAR(12) UNIQUE NOT NULL,                                                    -- ИНН
    organization_name VARCHAR(500) NOT NULL,                                            -- Наименование организации
    full_organization_name TEXT,                                                        -- Полное наименование организации
    registration_date DATE,                                                             -- Дата регистрации
    registry_date DATE,                                                                 -- Дата добавления в реестр
    organization_info TEXT,                                                             -- Общие сведения об организации
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица статусов организаций
CREATE TABLE organization_statuses (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,                                                              -- Год статуса
    spark_status VARCHAR(100),                                                          -- Статус СПАРК
    internal_status VARCHAR(100),                                                       -- Статус внутренний
    final_status VARCHAR(100),                                                          -- Статус ИТОГ
    msp_status VARCHAR(50),                                                             -- Статус МСП
    system_forming_enterprise BOOLEAN DEFAULT FALSE,                                    -- Системообразующее предприятие
    special_status BOOLEAN DEFAULT FALSE,                                               -- Наличие особого статуса
    moscow_support_received BOOLEAN DEFAULT FALSE,                                      -- Получена поддержка от г. Москвы
    enterprise_size VARCHAR(100),                                                       -- Размер предприятия (итог)
    enterprise_size_by_employees VARCHAR(100),                                          -- Размер предприятия (по численности)
    enterprise_size_by_revenue VARCHAR(100),                                            -- Размер предприятия (по выручке)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, year)
);

-- Таблица отраслевой информации
CREATE TABLE organization_industries (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    main_industry VARCHAR(300),                                                         -- Основная отрасль
    main_subindustry VARCHAR(300),                                                      -- Подотрасль (Основная)
    additional_industry VARCHAR(300),                                                   -- Дополнительная отрасль
    additional_subindustry VARCHAR(300),                                                -- Подотрасль (Дополнительная)
    industry_presentations TEXT,                                                        -- Отраслевые презентации
    main_okved VARCHAR(20),                                                             -- Основной ОКВЭД (СПАРК)
    main_okved_activity TEXT,                                                           -- Вид деятельности по основному ОКВЭД (СПАРК)
    production_okved VARCHAR(20),                                                       -- Производственный ОКВЭД
    production_okved_activity TEXT,                                                     -- Вид деятельности по производственному ОКВЭД
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица адресов организаций
CREATE TABLE organization_addresses (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    address_type VARCHAR(20) NOT NULL CHECK (address_type IN ('legal', 'production', 'additional')), -- Тип адреса
    address TEXT NOT NULL,                                                              -- Адрес
    latitude DECIMAL(9,6),                                                              -- Широта
    longitude DECIMAL(9,6),                                                             -- Долгота
    district VARCHAR(100),                                                              -- Округ
    area VARCHAR(100),                                                                  -- Район
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, address_type)
);

-- Таблица контактной информации
CREATE TABLE organization_contacts (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    director VARCHAR(300),                                                              -- Руководитель
    head_organization VARCHAR(500),                                                     -- Головная организация
    head_organization_inn VARCHAR(12),                                                  -- ИНН головной организации
    head_organization_relation_type VARCHAR(200),                                       -- Вид отношения головной организации
    management_contacts TEXT,                                                           -- Контактные данные руководства
    management_email VARCHAR(300),                                                      -- Почта руководства
    employee_contact TEXT,                                                              -- Контакт сотрудника организации
    phone_number VARCHAR(50),                                                           -- Номер телефона
    emergency_contact TEXT,                                                             -- Контактные данные ответственного по ЧС
    website VARCHAR(300),                                                               -- Сайт
    email VARCHAR(300),                                                                 -- Электронная почта
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица финансовых показателей по годам
CREATE TABLE financial_indicators (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,                                                              -- Год показателя
    revenue DECIMAL(15,2),                                                              -- Выручка предприятия, тыс. руб.
    net_profit DECIMAL(15,2),                                                           -- Чистая прибыль (убыток), тыс. руб.
    total_employees INTEGER,                                                            -- Среднесписочная численность персонала (всего по компании), чел
    moscow_employees INTEGER,                                                           -- Среднесписочная численность персонала, работающего в Москве, чел
    total_salary_fund DECIMAL(15,2),                                                    -- Фонд оплаты труда всех сотрудников организации, тыс. руб
    moscow_salary_fund DECIMAL(15,2),                                                   -- Фонд оплаты труда сотрудников, работающих в Москве, тыс. руб
    avg_salary_total DECIMAL(10,2),                                                     -- Средняя з.п. всех сотрудников организации, тыс.руб.
    avg_salary_moscow DECIMAL(10,2),                                                    -- Средняя з.п. сотрудников, работающих в Москве, тыс.руб.
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, year)
);

-- Таблица налоговых показателей по годам
CREATE TABLE tax_indicators (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,                                                              -- Год показателя
    moscow_taxes DECIMAL(15,2),                                                         -- Налоги, уплаченные в бюджет Москвы (без акцизов), тыс.руб.
    profit_tax DECIMAL(15,2),                                                           -- Налог на прибыль, тыс.руб.
    property_tax DECIMAL(15,2),                                                         -- Налог на имущество, тыс.руб.
    land_tax DECIMAL(15,2),                                                             -- Налог на землю, тыс.руб.
    personal_income_tax DECIMAL(15,2),                                                  -- НДФЛ, тыс.руб.
    transport_tax DECIMAL(15,2),                                                        -- Транспортный налог, тыс.руб.
    other_taxes DECIMAL(15,2),                                                          -- Прочие налоги
    excise_tax DECIMAL(15,2),                                                           -- Акцизы, тыс. руб.
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, year)
);

-- Таблица имущественно-земельного комплекса
CREATE TABLE property_assets (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    asset_type VARCHAR(20) NOT NULL CHECK (asset_type IN ('land', 'building')),         -- Тип актива: земля или здание
    cadastral_number VARCHAR(100),                                                      -- Кадастровый номер
    area DECIMAL(10,2),                                                                 -- Площадь
    permitted_use VARCHAR(300),                                                         -- Вид разрешенного использования
    ownership_type VARCHAR(100),                                                        -- Вид собственности
    owner VARCHAR(500),                                                                 -- Собственник
    building_type_and_purpose VARCHAR(300),                                             -- Тип строения и цель использования (только для зданий)
    production_area_sqm DECIMAL(10,2),                                                  -- Площадь производственных помещений, кв.м.
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица продукции организаций
CREATE TABLE organization_products (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    product_name TEXT NOT NULL,                                                         -- Название (виды производимой продукции)
    okpd2_code VARCHAR(50),                                                             -- Код ОКПД2
    product_type VARCHAR(200),                                                          -- Тип и сегмент продукции
    standardized BOOLEAN DEFAULT FALSE,                                                 -- Стандартизированная продукция
    in_catalog BOOLEAN DEFAULT FALSE,                                                   -- Включено в каталог продукции
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица экспортной деятельности
CREATE TABLE export_activities (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,                                                              -- Год
    export_volume DECIMAL(15,2),                                                        -- Объем экспорта, тыс. руб.
    export_countries TEXT,                                                              -- Перечень государств куда экспортируется продукция
    tn_ved_code VARCHAR(100),                                                           -- Код ТН ВЭД ЕАЭС
    has_export_supplies BOOLEAN DEFAULT FALSE,                                          -- Наличие поставок продукции на экспорт
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, year)
);

-- Таблица инвестиций
CREATE TABLE investments (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    year INTEGER NOT NULL,                                                              -- Год
    investments_moscow DECIMAL(15,2),                                                   -- Инвестиции в Москву, тыс. руб.
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(organization_id, year)
);

-- Таблица дополнительной деятельности
CREATE TABLE additional_activities (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    has_state_order BOOLEAN DEFAULT FALSE,                                              -- Наличие госзаказа
    production_capacity_utilization VARCHAR(100),                                       -- Уровень загрузки производственных мощностей
    export_volume_previous_year DECIMAL(15,2),                                          -- Объем экспорта за предыдущий календарный год
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Таблица источников данных
CREATE TABLE data_sources (
    id SERIAL PRIMARY KEY,
    organization_id INTEGER NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    source_type VARCHAR(10) NOT NULL CHECK (source_type IN ('xml', 'json', 'erp', 'diag', 'txt')),
    file_name VARCHAR(255),
    import_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    records_count INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- =============================================
-- Создание индексов для оптимизации запросов
-- =============================================

-- Индексы для таблицы organizations
CREATE INDEX idx_organizations_inn ON organizations(inn);
CREATE INDEX idx_organizations_name ON organizations(organization_name);
CREATE INDEX idx_organizations_registration_date ON organizations(registration_date);

-- Индексы для таблицы organization_statuses
CREATE INDEX idx_statuses_organization_id ON organization_statuses(organization_id);
CREATE INDEX idx_statuses_year ON organization_statuses(year);
CREATE INDEX idx_statuses_final_status ON organization_statuses(final_status);
CREATE INDEX idx_statuses_msp_status ON organization_statuses(msp_status);

-- Индексы для таблицы financial_indicators
CREATE INDEX idx_financial_organization_id ON financial_indicators(organization_id);
CREATE INDEX idx_financial_year ON financial_indicators(year);
CREATE INDEX idx_financial_revenue ON financial_indicators(revenue);
CREATE INDEX idx_financial_net_profit ON financial_indicators(net_profit);

-- Индексы для таблицы tax_indicators
CREATE INDEX idx_tax_organization_id ON tax_indicators(organization_id);
CREATE INDEX idx_tax_year ON tax_indicators(year);
CREATE INDEX idx_tax_moscow_taxes ON tax_indicators(moscow_taxes);

-- Индексы для таблицы organization_addresses
CREATE INDEX idx_addresses_organization_id ON organization_addresses(organization_id);
CREATE INDEX idx_addresses_type ON organization_addresses(address_type);
CREATE INDEX idx_addresses_district ON organization_addresses(district);
CREATE INDEX idx_addresses_area ON organization_addresses(area);

-- Индексы для таблицы export_activities
CREATE INDEX idx_export_organization_id ON export_activities(organization_id);
CREATE INDEX idx_export_year ON export_activities(year);

-- Индексы для таблицы property_assets
CREATE INDEX idx_property_organization_id ON property_assets(organization_id);
CREATE INDEX idx_property_type ON property_assets(asset_type);

-- Индексы для таблицы organization_products
CREATE INDEX idx_products_organization_id ON organization_products(organization_id);
CREATE INDEX idx_products_okpd2 ON organization_products(okpd2_code);

-- =============================================
-- Создание представлений для удобства запросов
-- =============================================

-- Представление для основных данных организаций с адресами
CREATE VIEW organization_full_info AS
SELECT 
    o.id,
    o.inn,
    o.organization_name,
    o.full_organization_name,
    o.registration_date,
    os.final_status,
    os.msp_status,
    oa_legal.address as legal_address,
    oa_production.address as production_address,
    fi.revenue as last_revenue,
    fi.year as last_financial_year
FROM organizations o
LEFT JOIN organization_statuses os ON o.id = os.organization_id 
    AND os.year = (SELECT MAX(year) FROM organization_statuses WHERE organization_id = o.id)
LEFT JOIN organization_addresses oa_legal ON o.id = oa_legal.organization_id AND oa_legal.address_type = 'legal'
LEFT JOIN organization_addresses oa_production ON o.id = oa_production.organization_id AND oa_production.address_type = 'production'
LEFT JOIN financial_indicators fi ON o.id = fi.organization_id 
    AND fi.year = (SELECT MAX(year) FROM financial_indicators WHERE organization_id = o.id);

-- Представление для финансового анализа
CREATE VIEW financial_analysis AS
SELECT 
    o.id,
    o.inn,
    o.organization_name,
    fi.year,
    fi.revenue,
    fi.net_profit,
    fi.total_employees,
    fi.avg_salary_total,
    ti.moscow_taxes,
    (fi.net_profit / NULLIF(fi.revenue, 0)) * 100 as profitability
FROM organizations o
JOIN financial_indicators fi ON o.id = fi.organization_id
LEFT JOIN tax_indicators ti ON o.id = ti.organization_id AND ti.year = fi.year;

-- =============================================
-- Функции для обновления временных меток
-- =============================================

-- Функция для автоматического обновления updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Триггеры для автоматического обновления updated_at
CREATE TRIGGER update_organizations_updated_at BEFORE UPDATE ON organizations FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- =============================================
-- Комментарии к таблицам и полям
-- =============================================

COMMENT ON TABLE organizations IS 'Основная таблица с организациями';
COMMENT ON COLUMN organizations.inn IS 'ИНН организации - уникальный идентификатор';
COMMENT ON COLUMN organizations.organization_name IS 'Краткое наименование организации';
COMMENT ON COLUMN organizations.full_organization_name IS 'Полное наименование организации';

COMMENT ON TABLE financial_indicators IS 'Финансовые показатели организаций по годам';
COMMENT ON COLUMN financial_indicators.revenue IS 'Выручка предприятия в тыс. руб.';
COMMENT ON COLUMN financial_indicators.net_profit IS 'Чистая прибыль (убыток) в тыс. руб.';

COMMENT ON TABLE tax_indicators IS 'Налоговые показатели организаций по годам';
COMMENT ON COLUMN tax_indicators.moscow_taxes IS 'Налоги, уплаченные в бюджет Москвы (без акцизов) в тыс. руб.';

-- =============================================
-- Завершение
-- =============================================

-- Создание пользователя для приложения (опционально)
-- CREATE USER app_user WITH PASSWORD 'secure_password';
-- GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO app_user;
-- GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO app_user;

-- Сообщение о успешном создании
DO $$ 
BEGIN
    RAISE NOTICE 'База данных успешно создана с 12 нормализованными таблицами';
    RAISE NOTICE 'Основные таблицы: organizations, financial_indicators, tax_indicators, organization_addresses';
    RAISE NOTICE 'Созданы индексы для оптимизации запросов';
    RAISE NOTICE 'Созданы представления для удобного доступа к данным';
END $$;